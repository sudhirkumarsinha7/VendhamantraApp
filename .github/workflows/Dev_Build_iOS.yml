name: iOS Dev ipa - Atum analytics

env:
  main_project_module: main
  playstore_name: Atum Analytics

on:
  workflow_dispatch:
    branches:
      - main

jobs:
  build:
    runs-on: macos-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set current date as env variable
        run: echo "date_today=$(date +'%Y-%m-%d')" >> $GITHUB_ENV

      - name: Set repository name as env variable
        run: echo "repository_name=$(echo '${{ github.repository }}' | awk -F '/' '{print $2}')" >> $GITHUB_ENV

      - name: Bump iOS version in app_version.json
        id: bump_ios_version
        run: |
          VERSION_FILE="app_version.json"

          if [ ! -f "$VERSION_FILE" ]; then
            echo "app_version.json not found!"
            exit 1
          fi

          CURRENT_VERSION_NAME=$(jq -r '.ios.version_name' "$VERSION_FILE")
          IOS_VERSION_CODE=$(jq -r '.ios.version_code' "$VERSION_FILE")

          echo "Current version_name: $CURRENT_VERSION_NAME"
          echo "iOS version_code: $IOS_VERSION_CODE"

          IFS='.' read -r MAJOR MINOR PATCH <<< "$CURRENT_VERSION_NAME"

          MAJOR=$((10#$MAJOR))
          MINOR=$((10#$MINOR))
          PATCH=$((10#$PATCH))

          PATCH=$((PATCH + 1))
          if [ "$PATCH" -gt 99 ]; then
            PATCH=0
            MINOR=$((MINOR + 1))
          fi
          if [ "$MINOR" -gt 99 ]; then
            MINOR=0
            MAJOR=$((MAJOR + 1))
          fi

          NEW_VERSION_NAME=$(printf "%d.%02d.%02d" "$MAJOR" "$MINOR" "$PATCH")
          NEW_IOS_VERSION_CODE=$((IOS_VERSION_CODE + 1))

          echo "New version_name: $NEW_VERSION_NAME"
          echo "New iOS version_code: $NEW_IOS_VERSION_CODE"

          # Update only ios.version_code and version_name fields
          jq --arg vn "$NEW_VERSION_NAME" \
            --argjson ivc "$NEW_IOS_VERSION_CODE" \
            '.version_name = $vn
              | .ios.version_name = $vn
              | .ios.version_code = $ivc' \
            "$VERSION_FILE" > tmp.$$.json && mv tmp.$$.json "$VERSION_FILE"

          echo "new_version=$NEW_VERSION_NAME" >> $GITHUB_ENV
          echo "new_ios_version_code=$NEW_IOS_VERSION_CODE" >> $GITHUB_ENV

      - name: Set version in Info.plist
        run: |
          /usr/libexec/PlistBuddy -c "Set :CFBundleShortVersionString ${{ env.new_version }}" ios/Atum_Analytics/Info.plist
          /usr/libexec/PlistBuddy -c "Set :CFBundleVersion ${{ env.new_ios_version_code }}" ios/Atum_Analytics/Info.plist
     
      - name: Commit and push iOS version updates
        env:
          GIT_TOKEN: ${{ secrets.GIT_TOKEN }}
          GITHUB_ACTOR: sudhir.kumar
        run: |
          git config user.name "Sudhir14819"
          git config user.email "sudhir.kumar@visaka.in"

          git add app_version.json ios/Atum_Analytics/Info.plist

          git commit -m "Bump iOS version to ${{ env.new_version }} (code ${{ env.new_ios_version_code }})" || echo "No changes to commit"

          git push "https://${GITHUB_ACTOR}:${GIT_TOKEN}@github.com/Visaka-Industries-Limited/atumanalyticsmobileapp.git" dev

      - name: Create .env file
        run: |
          cat <<EOF > .env
          REACT_APP_BASE_DOMAIN='${{ secrets.BASE_DOMAIN_NON_PROD }}'
          REACT_APP_GLOBAL_DOMAIN='${{ secrets.GLOBAL_DOMAIN_NON_PROD }}'
          REACT_APP_IMG_DOMAIN='${{ secrets.IMG_DOMAIN_NON_PROD }}'
          REACT_APP_CONTAINER_NAME='${{ secrets.ASSET_CONTAINER_NAME_NON_PROD }}'
          REACT_APP_IS_STAGING=true
          REACT_APP_PG_MERCHANT_ID='${{ secrets.PAYTM_MERCHANT_ID_NON_PROD }}'
          REACT_APP_PG_MERCHANT_KEY='${{ secrets.PAYTM_MERCHANT_KEY_NON_PROD }}'
          REACT_APP_PG_CALLBACK_URL='${{ secrets.PAYTM_CALLBACK_URL_NON_PROD }}'
          REACT_APP_PG_HOST_NAME='${{ secrets.PAYTM_HOST_NAME_NON_PROD }}'
          REACT_APP_PG_MERCHANT_URL='${{ secrets.PAYTM_MERCHANT_URL_NON_PROD }}'
          REACT_APP_API_URL='${{ secrets.API_URL_NON_PROD }}'
          REACT_APP_SERVICES_API_URL='${{ secrets.SERVICES_URL_NON_PROD }}'
          REACT_APP_IMAGE_API_URL='${{ secrets.IMAGE_URL_NON_PROD }}'
          REACT_APP_GOOGLE_MAPS_API_KEY='${{ secrets.REACT_APP_GOOGLE_MAPS_API_KEY }}'
          REACT_APP_USER_GUIDE='${{ secrets.USER_GUIDE_NON_PROD }}'

          EOF

      - name: Copy .env to iOS folder
        run: cp .env ./ios/.env

      - name: Install Apple certificate and provisioning profile
        env:
          BUILD_CERTIFICATE_BASE64: ${{ secrets.BUILD_CERTIFICATE_BASE64 }}
          P12_PASSWORD: ${{ secrets.P12_PASSWORD }}
          PROVISION_PROFILES_BASE64: ${{ secrets.PROVISION_PROFILES_BASE64 }}
          PROVISION_PROFILES_TESTING_BASE64: ${{ secrets.PROVISION_PROFILES_TESTING_BASE64 }}
          KEYCHAIN_PASSWORD: ${{ secrets.KEYCHAIN_PASSWORD }}
        run: |
          CERTIFICATE_PATH=$RUNNER_TEMP/certificate.p12
          PP_ARCHIVE=$RUNNER_TEMP/profiles.tgz
          PP_TESTING_ARCHIVE=$RUNNER_TEMP/profiles_testing.tgz
          KEYCHAIN_PATH=$RUNNER_TEMP/signing.keychain-db

          echo "$BUILD_CERTIFICATE_BASE64" | base64 --decode > "$CERTIFICATE_PATH"
          echo "$PROVISION_PROFILES_BASE64" | base64 --decode > "$PP_ARCHIVE"
          echo "$PROVISION_PROFILES_TESTING_BASE64" | base64 --decode > "$PP_TESTING_ARCHIVE"

          security create-keychain -p "$KEYCHAIN_PASSWORD" "$KEYCHAIN_PATH"
          security set-keychain-settings -lut 21600 "$KEYCHAIN_PATH"
          security unlock-keychain -p "$KEYCHAIN_PASSWORD" "$KEYCHAIN_PATH"

          security import "$CERTIFICATE_PATH" -P "$P12_PASSWORD" -A -t cert -f pkcs12 -k "$KEYCHAIN_PATH"
          security list-keychain -d user -s "$KEYCHAIN_PATH"

          mkdir -p ~/Library/MobileDevice/Provisioning\ Profiles

          # Extract and install original profiles
          tar -xzvf "$PP_ARCHIVE" -C $RUNNER_TEMP
          # Extract and install testing profiles
          tar -xzvf "$PP_TESTING_ARCHIVE" -C $RUNNER_TEMP

          for PROVISION in $(find $RUNNER_TEMP -name "*.mobileprovision"); do
            UUID=$(/usr/libexec/PlistBuddy -c 'Print :UUID' /dev/stdin <<< $(security cms -D -i "$PROVISION"))
            cp "$PROVISION" ~/Library/MobileDevice/Provisioning\ Profiles/$UUID.mobileprovision
          done

          security find-identity -v -p codesigning

      - name: Set up Node.js version
        uses: actions/setup-node@v3
        with:
          node-version: '22.x'

      - name: Install react packages
        run: npm install --force

      - name: Enable Corepack
        run: corepack enable
      - name: Install CocoaPods dependencies
        run: |
          cd ios
          pod install

      - name: Build archive (Release)
        run: |
          cd ios
          xcodebuild -workspace Atum_Analytics.xcworkspace \
            -scheme Atum_Analytics \
            -sdk iphoneos \
            -configuration Release \
            -archivePath $RUNNER_TEMP/Atum_Analytics.xcarchive \
            archive

      - name: Export .ipa
        env:
          EXPORT_OPTIONS_PLIST: ${{ secrets.EXPORT_OPTIONS_PLIST }}
        run: |
          EXPORT_OPTS_PATH=$RUNNER_TEMP/ExportOptions.plist
          echo "$EXPORT_OPTIONS_PLIST" | base64 --decode > "$EXPORT_OPTS_PATH"
          xcodebuild -exportArchive \
            -archivePath $RUNNER_TEMP/Atum_Analytics.xcarchive \
            -exportOptionsPlist "$EXPORT_OPTS_PATH" \
            -exportPath $RUNNER_TEMP/build

      - name: Clean up node_modules to free space
        if: always()
        run: rm -rf node_modules

      - name: Upload .ipa artifact
        uses: actions/upload-artifact@v4
        with:
          name: Atum_Analytics-ipa
          path: ${{ runner.temp }}/build/Atum_Analytics.ipa
          retention-days: 3